<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D-File</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.1.3/axios.min.js"></script>
    <script src="https://unpkg.com/js-base64"></script>
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAMxJREFUOE+t06FuAkEQxvH/FxpegUoeovXUoOobJLapRDaw2T1b21qwoNGUB8BW45jwDmQJENIj3F2vd0wyZjL7m2QmK2qGar7nCLSGsadIF2hfgOLTvGZFQ47A/Xt0iFFG45jI5Kp+x9acfg71v4Dc4YKHTdDqDHSAQ2ZFzKkvLdH3LyDegGYqixcsvHkt0sDiXxcRz+Y1rw7AiwVN6wB9CxpXB8SreX1VByIDS/RRBxhaonACXGyzYwo8lrzEmgZP5rS+zWcqOTWzbQ96PEURUT++WAAAAABJRU5ErkJggg=="
    />
    <!-- <script src="https://cdn.bootcdn.net/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.min.js"></script> -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        padding: 20px 0 10px;
        background: #000;
        color: #fff;
      }
      body {
        font-size: 16px;
        max-width: 80%;
        margin: 0 auto;
      }
      h2 {
        margin-bottom: 10px;
      }
      .back {
        display: inline-block;
        border: 1px solid #ff9000;
        padding: 4px 12px;
        font-size: 15px;
        font-weight: normal;
        cursor: pointer;
        margin-left: 20px;
        margin-top: 0;
        background: #ff9000;
        color: #000;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .back:hover {
        background: #000;
        color: #ff9000;
      }
      input.back {
        cursor: auto;
        background: #1b1b1b;
        border: 1px solid #333;
        color: #fff;
      }
      .ftr {
        float: right;
      }
      .file_list li {
        line-height: 40px;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        padding: 6px 0;
        cursor: pointer;
        transition: background 0.2s;
      }
      .file_list li:hover {
        background: rgba(255, 144, 0, 0.05);
      }
      .file_list li .checkbox {
        width: 18px;
        height: 18px;
        border: 2px solid #ff9000;
        margin-right: 10px;
        border-radius: 3px;
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
      }
      .file_list li.selected .checkbox:after {
        content: "✓";
        position: absolute;
        color: #ff9000;
        font-size: 14px;
        left: 2px;
        top: -2px;
      }
      .w50 .file_list li {
        float: left;
        width: 31%;
        margin-right: 2%;
      }
      .w50 .file_list li span.sha {
        display: none;
      }
      .file_list li:before {
        content: "其他";
        background: #1b1b1b;
        color: #fff;
        min-width: 40px;
        padding: 0 10px;
        line-height: 26px;
        height: 26px;
        font-size: 13px;
        margin-right: 8px;
        text-align: center;
        border-radius: 3px;
      }
      .file_list li.dir:before {
        content: "文件夹";
        background: #ff9000;
        color: #000;
      }
      .file_list li.img:before {
        content: "图片";
        background: #ff9000;
        color: #000;
      }
      .file_list li.video:before {
        content: "视频";
        background: #ff9000;
        color: #000;
      }
      .file_list li.music:before {
        content: "音频";
        background: #ff9000;
        color: #000;
      }
      .file_list li.code:before {
        content: "代码";
        background: #ff9000;
        color: #000;
      }
      .file_list li.zip:before {
        content: "压缩包";
        background: #ff9000;
        color: #000;
      }
      .file_list li.doc:before {
        content: "Word";
        background: #ff9000;
        color: #000;
      }
      .file_list li.xls:before {
        content: "Excel";
        background: #ff9000;
        color: #000;
      }
      .file_list li.ppt:before {
        content: "PPT";
        background: #ff9000;
        color: #000;
      }
      .file_list li.pdf:before {
        content: "PDF";
        background: #ff9000;
        color: #000;
      }
      .file_list li.txt:before {
        content: "文本";
        background: #ff9000;
        color: #000;
      }
      .file_list li img {
        margin-right: 6px;
        display: inline-block;
        vertical-align: middle;
      }
      .file_list li a {
        color: #fff;
        text-decoration: none;
        flex: 1;
        width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .file_list li.dir a {
        text-decoration: underline;
        color: #ff9000;
        font-weight: bold;
      }
      .file_list li.dir .del {
        visibility: hidden;
        pointer-events: none;
      }
      .file_list li span {
        color: #999;
        font-size: 14px;
      }
      .file_list li span.sha {
        min-width: 350px;
        display: inline-block;
      }
      .file_list li span.size {
        width: 80px;
        display: inline-block;
      }
      .file_list li i {
        border: 1px solid #ff9000;
        padding: 4px 12px;
        font-size: 14px;
        font-style: normal;
        cursor: pointer;
        margin-left: 10px;
        line-height: 20px;
        background: #ff9000;
        color: #000;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .file_list li i:hover {
        background: #000;
        color: #ff9000;
      }
      .file-img {
        width: 60px;
        max-height: 60px;
      }
      li {
        list-style-type: none;
      }
      @media screen and (max-width: 700px) {
        .file_list li span {
          display: none !important;
        }
        .back.ftr {
          display: none;
        }
        input#search {
          display: inline-block;
          margin: 10px 0 0;
        }
        button {
          margin-top: 6px;
        }
      }
      input {
        background: #1b1b1b;
        outline: none;
        line-height: 26px;
        border: 1px solid #333;
        padding: 0 10px;
        display: inline-block;
        min-width: 280px;
        margin-top: 6px;
        color: #fff;
        border-radius: 3px;
      }
      button {
        outline: none;
        background: #1b1b1b;
        border: 1px solid #333;
        display: inline-block;
        margin-left: 10px;
        line-height: 18px;
        padding: 4px 10px;
        cursor: pointer;
        color: #fff;
        border-radius: 3px;
        transition: all 0.2s;
      }
      button:hover {
        border-color: #ff9000;
      }
      button span {
        color: #ff9000;
        display: block;
      }
      #file {
        display: none;
      }
      h4 {
        overflow: hidden;
        margin-bottom: 20px;
      }
      h2 {
        padding: 10px 0;
        margin-bottom: 10px;
        border-bottom: 1px solid #333;
        overflow: hidden;
      }
      .tip {
        color: #999;
        font-size: 12px;
        margin-left: 20px;
      }
      i {
        font-style: normal;
      }
      .hide {
        display: none !important;
      }
      #loading {
        position: fixed;
        width: 100vw;
        height: 100vh;
        left: 0;
        top: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ff9000;
        z-index: 9;
        font-size: 20px;
      }
      .dropzone {
        border: 2px dashed #ff9000;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        transition: all 0.3s;
      }
      .dropzone.dragover {
        background: rgba(255, 144, 0, 0.1);
      }
      .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
      }
      .preview-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 90%;
        max-height: 90%;
      }
      .preview-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
      }
      .context-menu {
        position: fixed;
        background: #1b1b1b;
        border: 1px solid #333;
        border-radius: 3px;
        padding: 5px 0;
        z-index: 1000;
      }
      .context-menu-item {
        padding: 8px 15px;
        cursor: pointer;
        color: #fff;
      }
      .context-menu-item:hover {
        background: #ff9000;
        color: #000;
      }
      .file-actions {
        display: none;
        position: absolute;
        background: #1b1b1b;
        border: 1px solid #333;
        padding: 10px;
        border-radius: 3px;
      }
      .selected {
        background: rgba(255, 144, 0, 0.1);
      }
      @media screen and (max-width: 700px) {
        .dropzone {
          padding: 10px;
        }
        body {
          max-width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <p style="margin: 0">
      版本号: 20250101-1
      <span class="tip">测试延迟请在根目录上传<b>init.jpg</b>(50kb以内)</span>
    </p>
    <h4>
      根域名: <input type="text" value="" id="rootdm" />
      <div style="display: inline-block" id="btn-wrap"></div>
    </h4>
    <input type="file" id="file" class="filepond" name="filepond" />
    <h2>
      当前目录：<i id="repo"></i>
      <span onclick="addDir()" class="back">新建目录</span>
      <span onclick="document.getElementById('file').click()" class="back"
        >上传文件</span
      >
      <div
        id="batch-operations"
        style="display: inline-block; margin-left: 10px"
      >
        <span onclick="batchDelete()" class="back">批量删除</span>
        <span onclick="batchMove()" class="back">批量移动</span>
        <span onclick="batchCopy()" class="back">批量复制</span>
        <span onclick="shareFiles()" class="back">批量分享</span>
        <span
          id="selected-count"
          style="margin-left: 10px; color: #ff9000"
        ></span>
      </div>
      <span onclick="dirBack()" class="back">←返回</span>
      <span onclick="refresh()" class="back ftr">刷新</span>
      <span onclick="toggleWrap()" class="back ftr">分列</span>
      <span onclick="updateToken()" class="back ftr">设置Token</span>
      <span onclick="updateRepo()" class="back ftr">设置Repo</span>
      <input
        type="text"
        class="back ftr"
        id="search"
        placeholder="关键词搜索, 回车确认"
        onkeyup="search(event)"
      />
      <!-- <span onclick="history.go(-1)" class="back">返回</span> -->
    </h2>
    <div id="file_wrap">
      <ul class="file_list" id="file_list">
        加载中...
      </ul>
    </div>
    <div id="loading" class="hide">处理中...</div>
    <div class="dropzone">
      拖拽文件到此处上传 或 点击选择文件
      <input type="file" id="fileInput" multiple style="display: none" />
    </div>
    <div class="preview-modal">
      <div class="preview-close">×</div>
      <div class="preview-content"></div>
    </div>
    <div class="context-menu" style="display: none">
      <div class="context-menu-item" data-action="preview">预览</div>
      <div class="context-menu-item" data-action="copy">复制</div>
      <div class="context-menu-item" data-action="move">移动</div>
      <div class="context-menu-item" data-action="share">分享</div>
      <div class="context-menu-item" data-action="delete">删除</div>
    </div>

    <script>
      window.baseRepo = localStorage.getItem("GIT_REPO") || "dhjz/file";
      window.baseToken = localStorage.getItem("GIT_TOKEN") || "";
      if (!baseToken) alert("请先设置仓库和token");

      function toggleWrap() {
        var wrap = document.getElementById("file_wrap");
        wrap.className = wrap.className ? "" : "w50";
      }
      let urls = [
        { name: "本站", url: location.href },
        {
          name: "gitmirror加速",
          url: `https://raw.gitmirror.com/${baseRepo}/master/`,
        },
        {
          name: "jsdelivr加速",
          url: `https://gcore.jsdelivr.net/gh/${baseRepo}@master/`,
        },
        {
          name: "jsdelivr1加速",
          url: `https://cdn.jsdelivr.net/gh/${baseRepo}/`,
        },
      ];

      function initBtn() {
        let btnEl = document.getElementById("btn-wrap");
        for (let j = 0; j < urls.length; j++) {
          const temp = urls[j];
          const btn = document.createElement("button");
          btn.innerHTML = temp.name + `<span id="btn${j}"></span>`;
          let ig = new Image();
          ig.src = temp.url + "init.jpg?t=" + new Date().getTime();
          let start = new Date().getTime();
          ig.onload = function () {
            document.getElementById(`btn${j}`).innerHTML =
              new Date().getTime() - start + "ms";
          };
          ig.onerror = function () {
            document.getElementById(`btn${j}`).innerHTML = "延迟过高";
          };
          btn.onclick = function () {
            document.getElementById("rootdm").value = temp.url;
            initFileList();
          };
          btnEl.append(btn);
        }
      }
      initBtn();

      window.request = axios.create({
        baseURL: "https://api.github.com/",
        timeout: 10000,
        headers: {
          Authorization: "Bearer " + baseToken,
          Accept: "application/vnd.github+json",
          "X-GitHub-Api-Version": "2022-11-28",
        },
      });
      request.interceptors.response.use(
        function (response) {
          console.log("请求成功", response);
          hideLoading();
          return response;
        },
        function (error) {
          hideLoading();
          return Promise.reject(error);
        }
      );

      window.paths = [];
      window.en = Base64.encode;
      window.de = Base64.decode;

      window.fileList = [];
      function initFileList(searchVal) {
        let rootdm = document.getElementById("rootdm").value || "";
        let tempList = window.fileList;
        if (searchVal && searchVal.trim()) {
          tempList = window.fileList.filter((item) =>
            item.name.includes(searchVal.trim())
          );
        }
        if (window.fileList.length)
          document.getElementById("file_list").innerHTML = tempList
            .map((item) => {
              return `<li class="file ${item.ftype}" data-id="${item.sha}">
                <div class="checkbox" onclick="toggleFileSelection(this.parentElement, event)"></div>
                <a target="_blank" href="${rootdm}${
                item.path
              }" onclick="handleFileClick(event, '${
                item.type == "dir" ? item.path : ""
              }')">${item.name}</a>
                <span class='sha'>${item.sha}</span>
                <span class="size">${getUnit(item.size)}</span>
                <i onclick="delOne('${item.path}', '${
                item.sha
              }')" class="del">删除</i>
              </li>`;
            })
            .join("");

        document.getElementById("repo").innerHTML =
          baseRepo + "/" + (paths.length ? paths[paths.length - 1] : "");
      }

      // 初始化根目录
      if (baseToken) getDir("", true);

      function getDir(path, isRoot, event, isBack) {
        if (!path && !isRoot) return;
        if (event) event.preventDefault();
        showLoading();
        getContent(path + "?t=" + new Date().getTime()).then((data) => {
          console.log(data);
          window.fileList = (data || [])
            .filter((d) => d.name != "init.jpg")
            .map((item) => {
              item.ftype = getType(item.name);
              if (item.type == "dir") item.ftype = "dir";
              return item;
            });
          window.fileList.sort((a, b) => (a.type < b.type ? -1 : 1));
          if (path && !isBack) paths.push(path);
          initFileList();
        });
      }

      function addDir() {
        const val = prompt("请输入新建目录名称, 基于根目录, 不以/开头", "");
        if (val) {
          putDir(val);
        }
      }

      function dirBack() {
        if (!paths.length) return alert("已经是根目录了!");
        paths.pop();
        if (paths.length) {
          getDir(paths[paths.length - 1], false, null, true);
        } else {
          getDir("", true, null, true);
        }
      }

      function refresh() {
        if (paths.length) {
          getDir(paths[paths.length - 1], false, null, true);
        } else {
          getDir("", true, null, true);
        }
      }

      function search(e) {
        if (e.keyCode == 13) {
          initFileList(document.getElementById("search").value);
        }
      }

      function delOne(path, sha) {
        if (path == "index.html") return alert("主页index.html不能被删除!");
        if (window.confirm("是否确认删除改文件: " + path)) {
          delFile(path, sha, true);
        }
      }

      // putContent('ip.txt', base64Str)
      document.getElementById("file").addEventListener("input", (e) => {
        const file = e.target.files[0];
        if (file)
          putFile(
            paths.length
              ? paths[paths.length - 1] + "/" + file.name
              : file.name,
            file
          );
        document.getElementById("file").value = "";
      });

      function updateRepo() {
        const val = prompt(
          "请输入仓库 {owner}/{repo}",
          localStorage.getItem("GIT_REPO") || "dhjz/file"
        );
        if (val) localStorage.setItem("GIT_REPO", val) || location.reload();
      }

      function updateToken() {
        const val = prompt(
          "请输入token",
          localStorage.getItem("GIT_TOKEN") || ""
        );
        if (val) localStorage.setItem("GIT_TOKEN", val) || location.reload();
      }

      function getSha(path) {
        return new Promise((reso, rej) => {
          request
            .get(`/repos/${baseRepo}/contents/${path}`)
            .then((res) => reso(res.data.sha))
            .catch(() => reso(null));
        });
      }

      function getContent(path, isFull) {
        if (isFull) return request.get(`/repos/${baseRepo}/contents/${path}`);

        return new Promise((reso, rej) => {
          request
            .get(`/repos/${baseRepo}/contents/${path}`)
            .then((res) => {
              if (Array.isArray(res.data)) return reso(res.data);
              reso(Base64.decode(res.data.content));
            })
            .catch(() => {
              console.log("not exit file: " + path);
              reso(null);
            });
        });
      }

      function putContent(path, content) {
        const data = {
          message: now() + " update " + path,
          content: Base64.encode(content),
        };

        getSha(path).then((sha) => {
          if (sha) data.sha = sha;
          request.put(`/repos/${baseRepo}/contents/${path}`, data);
        });
      }

      function putDir(path) {
        const data = {
          message: now() + " create dir " + path,
          content: "",
        };

        getContent(path).then((res) => {
          if (Array.isArray(res)) return alert("该目录已存在");
          request
            .put(
              `/repos/${baseRepo}/contents/${path}${
                path.endsWith("/") ? "" : "/"
              }.init`,
              data
            )
            .then(() => {
              alert("新建目录成功: " + path);
              refresh();
            });
        });
      }

      function delFile(path, sha, isTip) {
        // getSha(path).then((sha) => {
        // }).catch((e) => console.log('not exit file: ' + path))
        request
          .delete(`/repos/${baseRepo}/contents/${path}`, {
            params: {
              message: now() + " del " + path,
              sha,
            },
          })
          .then(() => {
            if (isTip) alert("删除文件成功:" + path);
            refresh();
          });
      }

      function putFile(path, file) {
        console.log("upload file:", file);
        getSha(path).then((sha) => {
          if (sha && !window.confirm("已存在改文件, 是否覆盖?")) return;
          // if (sha && window.confirm('是否自动重命名?')) path = (new Date().getTime() + '').substr(0, 10) + '_' + path
          showLoading();
          const reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = async () => {
            const arrayBuffer = reader.result;
            const blob = new Blob([arrayBuffer], { type: file.type });
            const content = await blob.arrayBuffer();
            const data = {
              message: now() + " update " + path,
              path: path,
              content: btoa(chunkChar(new Uint8Array(content))),
              sha,
            };
            request
              .put(`/repos/${baseRepo}/contents/${path}`, data, {
                headers: {
                  "Content-Type": file.type,
                },
              })
              .then(() => {
                alert("上传成功:" + path + ", 大小:" + getUnit(file.size));
                refresh();
              });
          };
        });
      }

      function chunkChar(arr) {
        // content: btoa(String.fromCharCode(...new TextEncoder().encode(content))) 不太行
        // String.fromCharCode()方法最多可以接受65535个参数
        const chunkSize = 10000;
        const chunks = [];
        for (let i = 0; i < arr.length; i += chunkSize) {
          chunks.push(arr.slice(i, i + chunkSize));
        }
        const strings = chunks.map((chunk) => String.fromCharCode(...chunk));
        return strings.join("");
      }

      function now() {
        return new Date(new Date().getTime() + 8 * 60 * 60 * 1000)
          .toISOString()
          .replace("T", " ")
          .substring(0, 19);
      }

      function getType(val) {
        if (/\.(jpg|jpeg|png|gif)$/i.test(val)) return "img";
        if (/\.(mp4|avi|mov|wmv|flv)$/i.test(val)) return "video";
        if (/\.(mp3|wav|wma|aac)$/i.test(val)) return "music";
        if (/\.(doc|docx|odt)$/i.test(val)) return "doc";
        if (/\.(xls|xlsx)$/i.test(val)) return "xls";
        if (/\.(ppt|pptx)$/i.test(val)) return "ppt";
        if (/\.(pdf)$/i.test(val)) return "pdf";
        if (/\.(txt|ini|properties|yml|json|md)$/i.test(val)) return "txt";
        if (/\.(java|html|htm|css|js|php|h|go|)$/i.test(val)) return "code";
        if (/\.(zip|rar|7z|tar\.gz|tar\.bz2)$/i.test(val)) return "zip";
        return "other";
      }

      function getUnit(bytes, decimals = 2) {
        if (bytes === 0) return "0B";

        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + "" + sizes[i];
      }

      function showLoading(val) {
        document.getElementById("loading").innerHTML = val || "处理中...";
        document.getElementById("loading").className = "";
      }

      function hideLoading() {
        document.getElementById("loading").className = "hide";
      }

      // Drag and Drop functionality
      const dropzone = document.querySelector(".dropzone");
      const fileInput = document.getElementById("fileInput");

      dropzone.addEventListener("click", () => fileInput.click());

      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("dragover");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("dragover");
      });

      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("dragover");
        const files = e.dataTransfer.files;
        handleFiles(files);
      });

      fileInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
      });

      function handleFiles(files) {
        Array.from(files).forEach((file) => {
          const path = paths.length
            ? paths[paths.length - 1] + "/" + file.name
            : file.name;
          putFile(path, file);
        });
      }

      // 统一的批量操作处理函数
      function handleBatchOperation(operation) {
        const selectedItems = document.querySelectorAll(
          ".file_list li.selected"
        );
        if (!selectedItems.length) {
          alert("请先选择要操作的文件");
          return;
        }

        let targetPath = "";
        if (operation === "move" || operation === "copy") {
          targetPath = prompt("请输入目标路径（相对于根目录）：");
          if (!targetPath) return;
        }

        if (
          operation === "delete" &&
          !confirm(`确定要删除选中的 ${selectedItems.length} 个文件吗？`)
        ) {
          return;
        }

        showLoading(
          `正在${
            operation === "delete"
              ? "删除"
              : operation === "move"
              ? "移动"
              : "复制"
          }文件...`
        );
        let completedCount = 0;

        selectedItems.forEach((item) => {
          const fileName = item.querySelector("a").textContent;
          const currentPath = paths.length
            ? paths[paths.length - 1] + "/" + fileName
            : fileName;

          if (operation === "delete") {
            const sha = item.querySelector(".sha").textContent;
            delFile(currentPath, sha, false);
            completedCount++;
            if (completedCount === selectedItems.length) {
              hideLoading();
              alert("批量删除完成");
              refresh();
            }
          } else {
            const newPath = targetPath + "/" + fileName;

            getContent(currentPath, true).then((response) => {
              const data = {
                message:
                  now() + ` ${operation} ` + currentPath + " to " + newPath,
                content: response.data.content,
                sha: response.data.sha,
              };

              request
                .put(`/repos/${baseRepo}/contents/${newPath}`, data)
                .then(() => {
                  if (operation === "move") {
                    delFile(currentPath, response.data.sha, false);
                  }
                  completedCount++;
                  if (completedCount === selectedItems.length) {
                    hideLoading();
                    alert(`批量${operation === "move" ? "移动" : "复制"}完成`);
                    refresh();
                  }
                });
            });
          }
        });

        // 清除选择状态
        selectedFiles.clear();
        document.querySelectorAll(".file_list li.selected").forEach((item) => {
          item.classList.remove("selected");
        });
        updateSelectedCount();
      }

      // 批量删除
      function batchDelete() {
        handleBatchOperation("delete");
      }

      // 批量移动
      function batchMove() {
        handleBatchOperation("move");
      }

      // 批量复制
      function batchCopy() {
        handleBatchOperation("copy");
      }

      // 文件分享功能
      function shareFiles() {
        const selectedItems = document.querySelectorAll(
          ".file_list li.selected"
        );
        if (!selectedItems.length) {
          alert("请先选择要分享的文件");
          return;
        }

        const rootdm = document.getElementById("rootdm").value || "";
        let shareLinks = [];

        selectedItems.forEach((item) => {
          const fileName = item.querySelector("a").textContent;
          const currentPath = paths.length
            ? paths[paths.length - 1] + "/" + fileName
            : fileName;
          shareLinks.push(rootdm + currentPath);
        });

        const shareModal = document.createElement("div");
        shareModal.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: #1b1b1b;
          padding: 20px;
          border-radius: 5px;
          z-index: 1001;
          max-width: 80%;
          max-height: 80%;
          overflow: auto;
        `;

        shareModal.innerHTML = `
          <h3 style="margin-bottom: 10px">分享链接</h3>
          <textarea style="width: 100%; min-width: 300px; height: 150px; margin-bottom: 10px; background: #000; color: #fff; padding: 10px;">${shareLinks.join(
            "\n"
          )}</textarea>
          <button onclick="this.parentElement.remove()" class="back" style="float: right">关闭</button>
          <button onclick="navigator.clipboard.writeText(this.previousElementSibling.previousElementSibling.value)" class="back" style="float: right; margin-right: 10px">复制链接</button>
        `;

        document.body.appendChild(shareModal);
      }

      // 右键菜单处理
      document.querySelector(".context-menu").addEventListener("click", (e) => {
        const action = e.target.dataset.action;
        const fileItem = document.querySelector(".file_list li:hover");
        if (!fileItem) return;

        switch (action) {
          case "preview":
            const fileType = fileItem.className.split(" ")[1];
            const fileUrl = fileItem.querySelector("a").href;
            previewFileByUrl(fileUrl, fileType);
            break;
          case "copy":
          case "move":
            const fileName = fileItem.querySelector("a").textContent;
            const targetPath = prompt("请输入目标路径（相对于根目录）：");
            if (!targetPath) return;

            const currentPath = paths.length
              ? paths[paths.length - 1] + "/" + fileName
              : fileName;
            const newPath = targetPath + "/" + fileName;

            getContent(currentPath, true).then((response) => {
              const data = {
                message: now() + ` ${action} ` + currentPath + " to " + newPath,
                content: response.data.content,
                sha: response.data.sha,
              };

              request
                .put(`/repos/${baseRepo}/contents/${newPath}`, data)
                .then(() => {
                  if (action === "move") {
                    delFile(currentPath, response.data.sha, false);
                  }
                  refresh();
                });
            });
            break;
          case "share":
            const shareUrl = fileItem.querySelector("a").href;
            const shareModal = document.createElement("div");
            shareModal.style.cssText = `
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: #1b1b1b;
              padding: 20px;
              border-radius: 5px;
              z-index: 1001;
            `;

            shareModal.innerHTML = `
              <h3 style="margin-bottom: 10px">分享链接</h3>
              <input type="text" value="${shareUrl}" style="width: 100%; min-width: 300px; margin-bottom: 10px;" readonly>
              <button onclick="this.parentElement.remove()" style="float: right">关闭</button>
            `;

            document.body.appendChild(shareModal);
            break;
          case "delete":
            const path = fileItem
              .querySelector("a")
              .getAttribute("href")
              .split("/")
              .pop();
            const sha = fileItem.querySelector(".sha").textContent;
            if (confirm("确定要删除该文件吗？")) {
              delFile(path, sha, true);
            }
            break;
        }
      });

      // 文件预览功能
      function previewFileByUrl(url, fileType) {
        const modal = document.querySelector(".preview-modal");
        const content = document.querySelector(".preview-content");

        content.innerHTML = "";
        modal.style.display = "block";

        if (fileType === "img") {
          const img = document.createElement("img");
          img.src = url;
          img.style.maxWidth = "100%";
          content.appendChild(img);
        } else if (fileType === "pdf") {
          const iframe = document.createElement("iframe");
          iframe.src = url;
          iframe.style.width = "100%";
          iframe.style.height = "90vh";
          content.appendChild(iframe);
        } else if (fileType === "txt" || fileType === "code") {
          fetch(url)
            .then((response) => response.text())
            .then((text) => {
              const pre = document.createElement("pre");
              pre.textContent = text;
              pre.style.color = "#fff";
              pre.style.whiteSpace = "pre-wrap";
              content.appendChild(pre);
            });
        } else if (fileType === "video") {
          const video = document.createElement("video");
          video.src = url;
          video.controls = true;
          video.style.maxWidth = "100%";
          content.appendChild(video);
        } else if (fileType === "music") {
          const audio = document.createElement("audio");
          audio.src = url;
          audio.controls = true;
          audio.style.width = "100%";
          content.appendChild(audio);
        } else {
          const downloadLink = document.createElement("a");
          downloadLink.href = url;
          downloadLink.download = url.split("/").pop();
          downloadLink.innerHTML = `
            <div style="color: #fff; padding: 20px; text-align: center;">
              <div style="margin-bottom: 20px;">此文件类型暂不支持预览</div>
              <button class="back">点击下载</button>
            </div>
          `;
          content.appendChild(downloadLink);
        }
      }

      // Context Menu
      document.addEventListener("contextmenu", (e) => {
        const fileItem = e.target.closest(".file_list li");
        if (fileItem) {
          e.preventDefault();
          const contextMenu = document.querySelector(".context-menu");
          contextMenu.style.display = "block";
          contextMenu.style.left = e.pageX + "px";
          contextMenu.style.top = e.pageY + "px";
        }
      });

      // Hide context menu on click outside
      document.addEventListener("click", () => {
        document.querySelector(".context-menu").style.display = "none";
      });

      // File Preview
      function previewFile(file) {
        const modal = document.querySelector(".preview-modal");
        const content = document.querySelector(".preview-content");
        const fileType = file.type.split("/")[0];

        content.innerHTML = "";
        modal.style.display = "block";

        if (fileType === "image") {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.style.maxWidth = "100%";
          content.appendChild(img);
        } else if (
          fileType === "application" &&
          file.type === "application/pdf"
        ) {
          const iframe = document.createElement("iframe");
          iframe.src = URL.createObjectURL(file);
          iframe.style.width = "100%";
          iframe.style.height = "90vh";
          content.appendChild(iframe);
        } else if (fileType === "text") {
          const reader = new FileReader();
          reader.onload = (e) => {
            const pre = document.createElement("pre");
            pre.textContent = e.target.result;
            pre.style.color = "#fff";
            content.appendChild(pre);
          };
          reader.readAsText(file);
        }
      }

      // Close preview modal
      document.querySelector(".preview-close").addEventListener("click", () => {
        document.querySelector(".preview-modal").style.display = "none";
      });

      // Batch operations
      let selectedFiles = new Set();

      function handleFileClick(event, dirPath) {
        event.preventDefault();
        const target = event.target;
        const listItem = target.closest("li");

        if (dirPath) {
          // 如果是目录，进入目录
          getDir(dirPath, false, null);
        } else if (
          !event.target.classList.contains("del") &&
          !event.target.classList.contains("checkbox")
        ) {
          // 如果不是点击删除按钮或复选框，则选择/取消选择文件
          toggleFileSelection(listItem, event);
        }
      }

      function toggleFileSelection(element, event) {
        if (element.classList.contains("dir")) return; // 不允许选择目录

        if (event.shiftKey && lastChecked) {
          // Shift + 点击实现范围选择
          const items = Array.from(document.querySelectorAll(".file_list li"));
          const start = items.indexOf(element);
          const end = items.indexOf(lastChecked);

          items
            .slice(Math.min(start, end), Math.max(start, end) + 1)
            .forEach((item) => {
              if (!item.classList.contains("dir")) {
                item.classList.add("selected");
              }
            });
        } else if (event.ctrlKey || event.metaKey) {
          // Ctrl/Command + 点击实现多选
          element.classList.toggle("selected");
        } else {
          // 普通点击，清除其他选择，只选择当前文件
          document
            .querySelectorAll(".file_list li.selected")
            .forEach((item) => {
              if (item !== element) item.classList.remove("selected");
            });
          element.classList.toggle("selected");
        }

        lastChecked = element;
        updateSelectedCount();
      }

      function updateSelectedCount() {
        const selectedCount = document.querySelectorAll(
          ".file_list li.selected"
        ).length;
        const countElement = document.getElementById("selected-count");
        countElement.textContent = selectedCount
          ? `已选择 ${selectedCount} 个文件`
          : "";
      }

      // Add shift-click functionality for batch selection
      let lastChecked = null;
      document.addEventListener("click", (e) => {
        const fileItem = e.target.closest(".file_list li");
        if (fileItem && e.shiftKey && lastChecked) {
          const items = Array.from(document.querySelectorAll(".file_list li"));
          const start = items.indexOf(fileItem);
          const end = items.indexOf(lastChecked);
          items
            .slice(Math.min(start, end), Math.max(start, end) + 1)
            .forEach((item) => item.classList.add("selected"));
        }
        lastChecked = fileItem;
      });

      function batchCopy() {
        const selectedItems = document.querySelectorAll(
          ".file_list li.selected"
        );
        if (!selectedItems.length) {
          alert("请先选择要复制的文件");
          return;
        }

        const targetPath = prompt("请输入目标路径（相对于根目录）：");
        if (!targetPath) return;

        showLoading("正在复制文件...");
        let completedCount = 0;

        selectedItems.forEach((item) => {
          const fileName = item.querySelector("a").textContent;
          const currentPath = paths.length
            ? paths[paths.length - 1] + "/" + fileName
            : fileName;
          const newPath = targetPath + "/" + fileName;

          getContent(currentPath, true).then((response) => {
            const data = {
              message: now() + " copy " + currentPath + " to " + newPath,
              content: response.data.content,
              sha: response.data.sha,
            };

            request
              .put(`/repos/${baseRepo}/contents/${newPath}`, data)
              .then(() => {
                completedCount++;
                if (completedCount === selectedItems.length) {
                  hideLoading();
                  alert("批量复制完成");
                  refresh();
                }
              });
          });
        });
      }

      // 添加全选/取消全选功能
      function addSelectAllButton() {
        const selectAllBtn = document.createElement("span");
        selectAllBtn.className = "back";
        selectAllBtn.style.marginRight = "10px";
        selectAllBtn.onclick = toggleSelectAll;
        selectAllBtn.textContent = "全选";

        const batchOperations = document.getElementById("batch-operations");
        batchOperations.insertBefore(selectAllBtn, batchOperations.firstChild);
      }

      function toggleSelectAll() {
        const allFiles = document.querySelectorAll(".file_list li:not(.dir)");
        const allSelected = Array.from(allFiles).every((file) =>
          file.classList.contains("selected")
        );

        allFiles.forEach((file) => {
          file.classList.toggle("selected", !allSelected);
        });

        updateSelectedCount();
      }

      // 在页面加载完成后添加全选按钮
      addSelectAllButton();
    </script>

    <style>
      .gg-folder {
        transform: scale(var(--ggs, 1));
      }
      .gg-folder,
      .gg-folder::after {
        box-sizing: border-box;
        position: relative;
        display: block;
        width: 22px;
        height: 16px;
        border: 2px solid;
        border-radius: 3px;
      }
      .gg-folder::after {
        content: "";
        position: absolute;
        width: 10px;
        height: 4px;
        border-bottom: 0;
        border-top-left-radius: 2px;
        border-top-right-radius: 4px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        top: -5px;
      }
      .gg-file {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        width: 14px;
        height: 16px;
        border: 2px solid transparent;
        border-right: 0;
        border-top: 0;
        box-shadow: 0 0 0 2px;
        border-radius: 1px;
        border-top-right-radius: 4px;
        overflow: hidden;
      }
      .gg-file::after {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
        width: 6px;
        height: 6px;
        border-left: 2px solid;
        border-bottom: 2px solid;
        right: -1px;
        top: -1px;
      }
      .gg-image {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        width: 20px;
        height: 16px;
        overflow: hidden;
        box-shadow: 0 0 0 2px;
        border-radius: 2px;
      }
      .gg-image::after,
      .gg-image::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
        border: 2px solid;
      }
      .gg-image::after {
        transform: rotate(45deg);
        border-radius: 3px;
        width: 16px;
        height: 16px;
        top: 9px;
        left: 6px;
      }
      .gg-image::before {
        width: 6px;
        height: 6px;
        border-radius: 100%;
        top: 2px;
        left: 2px;
      }
      .gg-camera {
        box-sizing: border-box;
        position: relative;
        display: block;
        transform: scale(var(--ggs, 1));
        border: 2px solid;
        border-radius: 3px;
        width: 18px;
        height: 12px;
        perspective: 24px;
      }
      .gg-camera::after,
      .gg-camera::before {
        content: "";
        display: block;
        box-sizing: border-box;
        position: absolute;
      }
      .gg-camera::before {
        border: 2px solid;
        border-left-color: transparent;
        transform: rotateY(-70deg);
        width: 8px;
        height: 8px;
        right: -7px;
        top: 0;
      }
      .gg-camera::after {
        width: 10px;
        height: 5px;
        border-top: 2px solid;
        border-right: 2px solid;
        top: -5px;
        right: 2px;
        border-top-right-radius: 2px;
      }
      .gg-file.pdf:before {
        content: "pdf";
        font-size: 15px;
        position: absolute;
        bottom: -46%;
        font-style: normal;
        transform: scale(0.5) translateX(-54%);
      }
      .gg-file.doc:before {
        content: "doc";
        font-size: 15px;
        position: absolute;
        bottom: -46%;
        font-style: normal;
        transform: scale(0.5) translateX(-54%);
      }
    </style>
  </body>
</html>
